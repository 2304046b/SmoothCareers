@page "/applications/create"
@using Microsoft.EntityFrameworkCore
@using SmoothCareers.Domain
@using AppEntity = SmoothCareers.Domain.Application
@inject IDbContextFactory<SmoothCareers.Data.SmoothCareersContext> DbFactory
@inject NavigationManager NavigationManager

<PageTitle>Create Application</PageTitle>

<h1>Create Application</h1>
<hr />

<div class="row">
    <div class="col-md-5">
        <EditForm Model="Application" OnValidSubmit="AddApplication" FormName="applicationForm" Enhance>
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" />

            <!-- Job Post Dropdown -->
            <div class="mb-3">
                <label class="form-label">Job Post</label>
                <InputSelect class="form-control" @bind-Value="Application.JobPostId">
                    @foreach (var job in JobPosts)
                    {
                        <option value="@job.Id">@job.Title</option>
                    }
                </InputSelect>
            </div>

            <!-- Job Seeker (Auto) -->
            <div class="mb-3">
                <label class="form-label">Job Seeker ID</label>
                <InputNumber class="form-control" @bind-Value="Application.JobSeekerId" disabled />
            </div>

            <!-- Status (Auto) -->
            <div class="mb-3">
                <label class="form-label">Status</label>
                <InputText class="form-control" @bind-Value="Application.Status" disabled />
            </div>

            <!-- Dates (Auto) -->
            <div class="mb-3">
                <label class="form-label">Date Applied</label>
                <InputDate class="form-control" @bind-Value="Application.DateApplied" disabled />
            </div>

            <div class="mb-3">
                <label class="form-label">Date Created</label>
                <InputDate class="form-control" @bind-Value="Application.DateCreated" disabled />
            </div>

            <div class="mb-3">
                <label class="form-label">Date Updated</label>
                <InputDate class="form-control" @bind-Value="Application.DateUpdated" disabled />
            </div>

            <!-- Created / Updated By (Auto to jobseeker) -->
            <InputText @bind-Value="Application.CreatedBy" hidden />
            <InputText @bind-Value="Application.UpdatedBy" hidden />

            <button type="submit" class="btn btn-primary">Apply</button>
        </EditForm>
    </div>
</div>

<div class="mt-3">
    <a href="/applications">Back to List</a>
</div>

@code {
    private AppEntity Application { get; set; } = new();
    private List<JobPost> JobPosts = new();

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();

        JobPosts = await context.JobPost.ToListAsync();

        // Defaults for jobseeker
        Application.JobPostId = JobPosts.FirstOrDefault()?.Id ?? 0;
        Application.JobSeekerId = 1; // The seeded jobseeker
        Application.Status = "Pending";
        Application.DateApplied = DateTime.Today;
        Application.DateCreated = DateTime.Today;
        Application.DateUpdated = DateTime.Today;
        Application.CreatedBy = "jobseeker";
        Application.UpdatedBy = "jobseeker";
    }

    private async Task AddApplication()
    {
        using var context = DbFactory.CreateDbContext();
        context.Application.Add(Application);
        await context.SaveChangesAsync();
        NavigationManager.NavigateTo("/applications");
    }
}
